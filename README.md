# README

Written Felix M Key

Contact the author at key [at] shh [dot] mpg [dot] de for any questions about this code
or correspondence about this work.

This project is licensed under the terms of the CC BY.

This README provides an overview about the post-processing module of HOPS presented in:

HÃ¼bler, R., Key, F.M., et al. HOPS: automated detection and authentication of pathogen DNA in archaeological remains. Genome Biology 20, 280 (2019) doi: [10.1186/s13059-019-1903-0](https://doi.org/10.1186/s13059-019-1903-0)

Please cite this paper if any meaningful piece of the HOPS software is used.

Enjoy!

## Requirements

* R (tested on version 3.3.1 +)
* R libraries:
  * parallel
  * getopt
  * gridBase
  * gridExtra

Optional:

* R libraries:
  * jsonlite (if you want generate json-formatted raw heatmap data)

## Overview

Postprocessing has to be done on the output data generated by HOPS::MALTextract (beta v1.3+). It iterates over relevant files produced, and summarises potential positive hits in a heatmap and detailed profile-pdfs (please also see profilePDF_explained.pdf). The heatmap data in TSV format is also created, and a JSON version can also be requested.

## Example of usage

### Help menu

```bash
./postprocessing.AMPS.r -h

Usage: ./postprocessing.AMPS.r [-[-rmaex.out.fld|r] <character>] [-[-maltex.filter|m] [<character>]] [-[-threads|t] <double>] [-[-help|h]] [-[-node.list|n] <character>]
    -r|--rmaex.out.fld    MALTextract output folder.
    -m|--maltex.filter    MALTextract filter mode: <default,def_anc>. This script is not designed for 'scan' output. Default: <def_anc>.
    -t|--threads          Max number of cores used.
    -h|--help             Print this help.
    -s|--sequencestrategy Sequencing Strategy: <pe,se>, for needing damage only on forward or both forward and reverse strands
    -d|--dmgcutoff        Cutoff threshold for 3 prime damage for outputting plot. Default: 0, no cutoff is used
    -c|--readdistcutoff   Cutoff threshold for read distribution (stacking) for outputting plot. Default: 0, no cutoff is used
    -e|--defratio         Absolute value sums of edit distances of ratio between successive bars of default edit distance needed to exceed for outputting plot, lower value is more permissive. Default: 0.9
    -a|--ancratio         Ratio between successive bars of ancient edit distance needed to exceed for outputting plot, lower value is more permissive. Default: 0.8
    -f|--firm             Use firm cutoffs, only output if all thresholds met for outputting plots, eg dmg, read dist, def ratio and anc ratio
    -n|--node.list        List (\n separated) (or path to file) of nodes to be reported on (aka input species/node list used for MALTextract).
    -j|--heatmap.json    Optional exporting of heatmap data in json format.
```

### Example command

```bash
~/path/to/amps/postprocessing.AMPS.r \
-r HOPS/output/folder \
-m def_anc \
-t 16 \
-s pe \
-d 0.5 \
-c 0.25 \
-e 0.9 \
-a 0.8 \
-f \
-n /path/to/List_of_pathogens.txt
```
